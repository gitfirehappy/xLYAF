local DialogueView = {}
local stringUtil = require("StringUtil")

-- UI组件引用
local uiRefs = {
    panel = nil,
    optionsParent = nil,
    characterNameText = nil,
    contentText = nil,
}

local function getController()
    return require("DialogueController")
end

local function InitUI()
    if uiRefs.panel then return end
    uiRefs.panel = CS.UIManager.Instance:GetForm("DialoguePanel")

    -- 绑定UI组件
    uiRefs.optionsParent = uiRefs.panel.optionsParent
    uiRefs.contentText = uiRefs.panel.contentText
    uiRefs.characterNameText = uiRefs.panel.characterNameText
    
    DialogueView.HideOptions()
end

function DialogueView:OnPointerClick(eventData)
    CS.UnityEngine.Debug.Log("对话面板被点击，触发Next")
    getController().Next()
end

-- 显示对话面板
function DialogueView.ShowDialogue()
    InitUI()
    CS.UIManager.Instance:ShowUIForm("DialoguePanel")
end

-- 隐藏对话面板
function DialogueView.HideDialogue()
    if uiRefs.panel then
        CS.UIManager.Instance:HideUIForm("DialoguePanel")
        uiRefs.panel = nil
        uiRefs.optionsParent = nil
        uiRefs.contentText = nil
        uiRefs.characterNameText = nil
    end
end

-- 更新对话
function DialogueView.UpdateDialogue(dialogueData)
    if not uiRefs.panel then return end
    
    local characterName = dialogueData.Character or ""
    local content = dialogueData.Content or ""
    local posAndOp = dialogueData.PosAndOp or ""
    
    -- 更新角色名和内容
    -- 第一个角色名为说话人
    -- 分隔好角色名和操作作为List<string>传入CS.DialoguePanel.UpdateCharacter
    local characterNames = stringUtil.SplitSemicolon(characterName)
    local posAndOps = stringUtil.SplitSemicolon(posAndOp)
    
    uiRefs.contentText.text = content
    uiRefs.characterNameText.text = characterNames[1]
    
    CS.UnityEngine.Debug.Log("已更新角色名和内容")
    
    uiRefs.panel:UpdateCharacter(characterNames, posAndOps)
    
    CS.UnityEngine.Debug.Log("已更新角色位置和操作")
end

-- 显示选项
function DialogueView.ShowOptions(options, callback)
    if not uiRefs.panel then return end

    -- 提取选项文本
    local optionTexts = {}
    for _, option in ipairs(options) do
        table.insert(optionTexts, option.Content or "")
    end
    
    -- 创建并显示选项
    -- C#端创建时会自动绑定传入的回调
   uiRefs.panel:CreateOptions(optionTexts, callback)
end

-- 隐藏选项
function DialogueView.HideOptions()
    if uiRefs.optionsParent then
        -- 清空并隐藏现有选项
        uiRefs.panel:ClearOptions()
    end   
end

return DialogueView
